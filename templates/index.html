<!DOCTYPE html>
 <html lang="en">
 
 <head>
 
     <title> Stock Portfolio Suggestion Engine </title>
 
     <!-- Bootstrap core CSS -->
     <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  
     <script
      src="https://code.jquery.com/jquery-1.12.4.min.js"
      integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
      crossorigin="anonymous"> 
      </script>    
     <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
     <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style type="text/css">
    body{
        position: relative; /* required */
        padding-top: 70px;  /* prevent content to go underneath the fixed navbar */
        font-size: 18px;
        font-style: lucida;
        }
    </style>
    <script type="text/javascript">
    $(document).ready(function(){
        $("body").scrollspy({
            target: "#myNavbar",
            offset: 70
        }) 
    });

    </script>
 
 </head>
 
 <body background="{{url_for('static', filename='ny2.jpg')}}" style="background-repeat: no-repeat; background-attachment: fixed; background-size:cover;">

 <nav id="myNavbar" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
 
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header col-md-4">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbarCollapse"> 
                    <span class="sr-only">Toggle navigation</span> 
                    <span class="icon-bar"></span> 
                    <span class="icon-bar"></span> 
                    <span class="icon-bar"></span> 
                </button>
                <a class="navbar-brand" href="#search_box" style="font-size: 25px">Stock Portfolio Suggestion Engine</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse col-md-2" id="navbarCollapse" align ="left">
                <ul class="nav navbar-nav">
                    
                    <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">See My Portfolio!<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        <li class="active"><a href="#live_portfolio_announcement">Portfolio Breakdown</a></li>
                        <li><a href="#portfolio_title_history">Week history</a></li>
                        <li><a href="#stocks_piechart">Amount Breakdown</a></li>
                        <li><a href="#counts_piechart">Share Breakdown</a></li>

                        </ul>
                    </li>
                </ul>
            </div>

            <div class="container col-md-5" align="right">
        
        <script type="text/javascript">
            if(!window.wbiGlobalScope){window.wbiGlobalScope=[]}function ieIntervalHandler(id,strFunc){var scope=window.wbiGlobalScope[id];eval("scope."+strFunc+"()")}function WBIHorizontalTicker(a){this.textW=0;this.containerW=0;this.scroller=null;this.destLoc=0;this.moveAmount=1;this.moveInterval=30;this.refreshData=20000;this.pauseAnimation=true;this.sub_symbols;this.updatingList=false;this.scrolling=false;this.animationStarted=false;this.listName=a;this.scollerID="";this.timer=null;this.alsoMove=null;this.animate=true;this.animationHost=null;this.start=function(){var c=new Date();this.scollerID="wbi_scroller_"+c.getSeconds().toString()+c.getMilliseconds().toString()+Math.floor(Math.random()*101).toString();var b='<div class="wbiscroller" style="width: 100%;font-size: 12pt; ;height: 30px; width: 100%; position: relative; overflow: hidden; border:none; background-image:none;     padding-top: 15px;padding-bottom: 15px;"><div class="scrollingtext" id="'+this.scollerID+'"></div></div>';document.writeln(b);window.wbiGlobalScope[this.scollerID.toString()]=this;var d="#"+this.scollerID;this.scroller=$(d);this.scroller.mouseenter(this.OnMouseOver);this.scroller.mouseleave(this.OnMouseOut);this.UpdateList();this.startTimer()};this.startTimer=function(){if(document.all){setInterval('ieIntervalHandler("'+this.scollerID+'","UpdateValues")',this.refreshData)}else{this.timer=setInterval(function(b){b.UpdateValues()},this.refreshData,this)}};this.StartAnimationTimer=function(){if(document.all){setInterval('ieIntervalHandler("'+this.scollerID+'","AnimateLoop")',this.moveInterval)}else{this.timer=setInterval(function(b){b.AnimateLoop()},this.moveInterval,this)}};this.setInitialLocation=function(){this.scroller.css({left:(this.containerW*0.75)});if(this.alsoMove!=null){this.alsoMove.scroller.css({left:(this.containerW*0.75)})}};this.OnMouseOver=function(){var b=$(this).attr("id");var c=window.wbiGlobalScope[b.toString()];if(c.animationHost==null){c.pauseAnimation=true}else{c.animationHost.pauseAnimation=true}};this.OnMouseOut=function(){var b=$(this).attr("id");var c=window.wbiGlobalScope[b.toString()];if(c.animationHost==null){c.pauseAnimation=false}else{c.animationHost.pauseAnimation=false}};this.configureAnimation=function(){this.textW=this.scroller.width();this.containerW=this.scroller.parent().width();this.setInitialLocation();this.destLoc=-this.textW+(this.containerW*0.15);if(this.animate){this.StartAnimationTimer()}};this.AnimateLoop=function(){if(this.pauseAnimation==false){var b=this.scroller.position().left;if(b<=this.destLoc){this.pauseAnimation=true;this.UpdateList()}b-=this.moveAmount;this.scroller.css({left:b});if(this.alsoMove!=null){this.alsoMove.scroller.css({left:b})}}};this.getListHeader=function(){if(this.listName=="gainers"){return"Gainers:"}else{if(this.listName=="losers"){return"Top 10 Losers"}}};this.getTableHeader=function(){var b=b='<span style="margin-right:5px;color:white;font-style:bold;">'+this.getListHeader()+", </span>";return b};this.getTableFooder=function(){var b='<span style="margin-right:5px;color:white;font-style:bold;"><a style="color:white;" href="http://widgets.freestockcharts.com/Gallery.aspx" target="_blank"></a></span>';return b;var b="";return b};this.getSymbolDiv=function(b){var e=b.n.replace(".","_");e=e.replace("/","_");var d='<span class="WLSymbolItem" id="'+e+'_display"><a class="sym" target="_parent" href="http://www.freestockcharts.com/?Symbol='+b.n+'&source=TickerWidget">';var c="http://widgets.freestockcharts.com/WidgetServer/images/greenup.png";if(b.v1.substr(0,1)=="-"){c="http://widgets.freestockcharts.com/WidgetServer/images/reddown.png"}d+=b.n+' <span style="padding-left:3px;margin-right:3px;color:silver;" class="quoteup" id="'+e+'_quote">'+b.v2+'</span><span style="height:100%;" class="dirup" id="'+e+'_dir"><img alt="" border="0" id="'+e+'_img" src="'+c+'" /></span><span class="quoteup" id="'+e+'_change">'+b.v1+"</span>";d+="</a></span>";return d};this.clearChangeClass=function(){var e=sub_symbols.split(",");for(i=0;i<=e.length-1;i++){var c="#"+e[i]+"_quote";var d="#"+e[i]+"_change";var b="#"+e[i]+"_display";$(b).removeClass("valueChanged")}};this.NewDataCallback=function(d){if((d!=null)){if(d.length>0){this.sub_symbols="";var c="";c=this.getTableHeader();for(i=0;i<=d.length-1;i++){var b=d[i];this.sub_symbols+=b.n;if(i<d.length-1){this.sub_symbols+=","}c+=this.getSymbolDiv(b)}c+=this.getTableFooder();this.scroller.empty();this.scroller.append(c);this.updatingList=false;this.UpdateValues();if(this.animationStarted==false){this.animationStarted=true;this.configureAnimation()}this.setInitialLocation();this.pauseAnimation=false}}this.updatingList=false};this.UpdateList=function(){this.updatingList=true;var c=new Date();var b=c.getHours().toString()+c.getMinutes().toString()+c.getSeconds().toString()+c.getMilliseconds().toString();$.getJSON("http://widgets.freestockcharts.com/WidgetServer/DynamicLists.ashx?name="+this.listName+"&senderID="+this.scollerID+"&take=10&cbust="+b+"&jsoncallback=?",function(e,f){if((e!=null)){var d=window.wbiGlobalScope[e.senderId.toString()];d.NewDataCallback(e.lst)}})};this.newQuotedata=function(b,c){if((b!=null)){if(b.length>0){for(i=0;i<=b.length-1;i++){this.updateSymbolData(b[i].Symbol,b[i].Price,b[i].vol,b[i].percent,b[i].isUp)}}}};this.UpdateValues=function(){if(this.updatingList){return}var c=new Date();var b=c.getHours().toString()+c.getMinutes().toString()+c.getSeconds().toString()+c.getMilliseconds().toString();$.getJSON("http://widgets.freestockcharts.com/Ajaxserver.aspx?service=DATA&senderID="+this.scollerID+"&sym="+this.sub_symbols+"&cbust="+b+"&jsoncallback=?",function(e,f){if((e!=null)){var d=window.wbiGlobalScope[e.sid.toString()];d.newQuotedata(e.quotes)}})};this.updateSymbolData=function(d,f,e,k,c){d=d.replace(".","_");d=d.replace("/","_");var j="#"+d+"_quote";var h="#"+d+"_change";var m="#"+d+"_dir";var n="#"+d+"_img";var l="#"+d+"_vol";var b="#"+d+"_display";var g=$(j).text();$(j).text(f);$(h).text(k);$(b).removeClass("valueChanged");if(c){$(h).removeClass("changedown");$(h).addClass("changeup");$(j).removeClass("changedown");$(m).removeClass("dirdown");$(m).addClass("dirup");$(n).attr("src","http://widgets.freestockcharts.com/WidgetServer/images/greenup.png")}else{$(h).removeClass("changeup");$(h).addClass("changedown");$(j).removeClass("changeup");$(m).removeClass("dirup");$(m).addClass("dirdown");$(n).attr("src","http://widgets.freestockcharts.com/WidgetServer/images/reddown.png")}}};
        </script> 

        <link href="http://widgets.freestockcharts.com/WidgetServer/WBITickerblue.css" rel="stylesheet" type="text/css" />
        <script>

            var gainTicker = new WBIHorizontalTicker('gainers');
            gainTicker.start();
            </script> <!-- End Scrolling Ticker Widget -->
    </div>

        </div>
    </nav>

    

     <div class="container">
 
         <form class="form-signin" action="/calculate" method="post" role="form" id="search_box">


             <!--dropdown for strategy 1-->
             <!--dropdown for strategy 1-->
            <label> Select primary investment strategy: </label>
              <select name="strategy_1"  class="form-control input-sm" style="background: transparent;">
                <option> None </option>
                <option>Index</option>
                <option>Value</option>
                <option>Growth</option>
                <option>Ethical</option>
                <option>Quality</option>
              </select>
              <br>

            <!--dropdown for strategy 2-->
            <label> Select secondary investment strategy: </label>
              <select name="strategy_2"  class="form-control input-sm" style="background-color: transparent;">
                <option> None </option>
                <option>Index</option>
                <option>Value</option>
                <option>Growth</option>
                <option>Ethical</option>
                <option>Quality</option>
              </select>
              <br>

            <label> Investment amount: </label>        
             <input type="text" name="total_amount" id="symbol" class="form-control" placeholder="Enter Amount To Invest" required autofocus> 
             <br>
             <button class="btn btn-lg btn-primary btn-block" type="button" id="calc_button">Calculate </button>
             <button class="btn btn-lg btn-warning btn-block" type="button" id="refresh_button">Reset </button>
         </form>
     </div>

<div id="output" style="visibility: none">
    <h3 align='center' id='live_portfolio_announcement'> Live portfolio value: 
        <span id='live_portfolio_value'> </span> 
    </h3>

    <br><br> <h3 align='center' id ='portfolio_title'> Portfolio breakdown: </h3> <br>
    <div class='container'>
     <div class="row" id='main_container'>
           <div class = 'col-md-12' id='stock_container'> 
           <table id='stock_table' class="table">
           </table>         
           </div>           
     </div>
     </div>
    
    <br><br> <h4 align='center' id ='portfolio_title_history'> Portfolio 5-day history: </h3> <br>
    <div class="container" id='five_day_stocks' style='width: 900px; height: 500px;'></div>
    <div class="container" id='portfolio_stocks' style='width: 900px; height: 500px;'></div>
     
    <br><br> <h4 align='center' id ='portfolio_title_pies'> Portfolio breakdown charts: </h3> <br>
    <div class="container" id="stocks_piechart" style="width: 900px; height: 500px;"></div>
    <div class="container" id="counts_piechart" style="width: 900px; height: 500px;"></div>
         </div>
     </div>

</div>


     
   <script type="text/javascript">
        var g_portfolio;
        var show_live_value = false;
         
        function drawStockChart(){
            var input = [];
            var rows = [];
            var heading = ['Date'];
            for (var stock in g_portfolio){
                heading.push(g_portfolio[stock].name);
            }
            rows.push(heading);
            for(var i = 0; i < 5; i++){
                var is_date_filled = false;
                for (var stock in g_portfolio){
                    //need to add date, and five days of closes
                    if(is_date_filled === false){
                        input.push(g_portfolio[stock].five_day_data[i]['Date']);
                        is_date_filled = true;
                    }
                    var stock_price = parseInt(g_portfolio[stock].five_day_data[i]['Close']);
                    input.push(stock_price);
                }
                rows.push(input);
                input = []
            }
            var data = new google.visualization.arrayToDataTable(rows);
            var options = {
                title: 'Five day history (individual stocks)',
                legend: { position: 'right' },
                backgroundColor: { fill:'transparent' }
            };
            var chart = new google.visualization.LineChart(document.getElementById('five_day_stocks'));
            chart.draw(data, options);
        }
        function drawPortfolioChart(){
            var input = [];
            var rows = [];
            var heading = ['Date', 'Closing Portfolio Value'];
            rows.push(heading);
            for(var i = 0; i < 5; i++){
                var is_date_filled = false;
                var portfolio_price = 0;
                var portfolio_total = 0;
                for (var stock in g_portfolio){
                    //need to add date, and five days of closes
                    if(is_date_filled === false){
                        input.push(g_portfolio[stock].five_day_data[i]['Date']);
                        is_date_filled = true;
                    }
                    portfolio_price = parseInt(g_portfolio[stock].five_day_data[i]['Close']);
                    number_of_stocks = parseInt(g_portfolio[stock].count);
                    portfolio_total += (portfolio_price * number_of_stocks);
                }
                input.push(portfolio_total);
                rows.push(input);
                portfolio_total = 0;
                input = []
            }
            var data = new google.visualization.arrayToDataTable(rows);
            var options = {
                title: 'Five day history (portfolio)',
                legend: { position: 'bottom' },
                backgroundColor: { fill:'transparent' }
            };
            var chart = new google.visualization.LineChart(document.getElementById('portfolio_stocks'));
            chart.draw(data, options);
        }
        function drawPieChart() {
            var rows = [];
            rows.push(['Stock', 'Amount spent']);
            for (var stock in g_portfolio){
                var input = [];
                input.push(g_portfolio[stock].name);
                input.push(g_portfolio[stock].amount);
                rows.push(input);
            }
            var data = google.visualization.arrayToDataTable(rows);
            var options = {
              title: 'Portfolio breakdown by stock',
              backgroundColor: { fill:'transparent' }
            };
            var chart = new google.visualization.PieChart(document.getElementById('stocks_piechart'));
            chart.draw(data, options);
        }
        function drawPieChartByCount() {
            var rows = [];
            rows.push(['Stock', 'Stocks bought']);
            for (var stock in g_portfolio){
                var input = [];
                input.push(g_portfolio[stock].name);
                input.push(g_portfolio[stock].count);
                rows.push(input);
            }
            var data = google.visualization.arrayToDataTable(rows);
            var options = {
              title: 'Portfolio breakdown by shares',
              backgroundColor: { fill: 'transparent'}
            };
            var chart = new google.visualization.PieChart(document.getElementById('counts_piechart'));
            chart.draw(data, options);
        }
         $(function(){
            $("#stock_image").hide();
            $("#portfolio_image").hide();
            $('#portfolio_title').hide();
            $('#portfolio_title_history').hide();
            $('#portfolio_title_pies').hide();
            $('#live_portfolio_announcement').hide();
            $(window).keydown(function(event){
                if(event.keyCode == 13){
                    $("#calc_button").click();
                    event.preventDefault();
                    return false;
                }
            });
            function update_values() {
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
            $.getJSON($SCRIPT_ROOT+"/live_value",
                function(data) {
                    console.log(data);
                    if (data.live_value !== 0 && show_live_value === true){
                    $('#live_portfolio_announcement').show();
                    $("#live_portfolio_value").show();
                    $("#live_portfolio_value").text(data.live_value);
                    }
                });
            }
            window.setInterval(function(){
              update_values();
            }, 5000);

            $('#refresh_button').click(function(){
                location.reload();
                $('live_portfolio_announcement').hide();
                show_live_value = false;
            });


            $('#calc_button').click(function(){
                show_live_value = true;
                var symbol = $('#symbol').val();
                $.ajax({
                    url: '/calculate',
                    data: $('form').serialize(),
                    type: 'POST',
                    success: function(response) {
                        //console.log(response)
                        //handle all errors here
                        if(response['code'] != 0){
                            alert(response['message'])
                            return;
                        }
                        //else, continue
                        $('#outputno').show();
                        $("#stock_image").show();
                        $("#portfolio_image").show();
                        
                        d = new Date();
                        //$("#stock_image").attr("src", "static/stocks.png?"+d.getTime());  
                        //$("#portfolio_image").attr("src", "static/portfolio.png?"+d.getTime());                        
                        var portfolio = response.portfolio;
                        portfolio = JSON.parse(portfolio);
                        g_portfolio = portfolio;
                        $('#portfolio_title').show();
                        $('#portfolio_title_history').show();
                        $('#portfolio_title_pies').show();
                        var heading = '<thead class="thead-inverse"> <tr>' + 
                                            '<th> STOCK </th> <th> NAME</th> <th>INVESTMENT STRATEGY</th>' +
                                            '<th> NO: STOCKS BOUGHT </th> <th> PRICE </th> <th> AMOUNT SPENT FOR STOCK </th>' +
                                            '</tr> </thead> <tbody> </tbody>';
                        $('#stock_table').append(heading);
                        for (var stock in portfolio){
                            var string_of_rows = '<tr>' + '<td>' + '<h5>' + stock + '</h5>' + '</td>' +
                            '<td>' + portfolio[stock].name + '</td>' +
                            '<td>' + portfolio[stock].strategy  + '</td>' +
                            '<td>' + portfolio[stock].count + '</td>' +
                            '<td>' + portfolio[stock].price + '</td>' +
                            '<td>' + portfolio[stock].amount + '</td>' + '</tr>';
                            $('#stock_table > tbody:last-child').append(string_of_rows);
                        }
                        google.charts.load("current", {packages:["corechart"]});
                        google.charts.setOnLoadCallback(drawStockChart);
                        google.charts.setOnLoadCallback(drawPortfolioChart);
                        google.charts.setOnLoadCallback(drawPieChart);
                        google.charts.setOnLoadCallback(drawPieChartByCount);
                        
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
                
            });
         });
     </script>

 </body>
 
 </html>