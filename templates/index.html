<!DOCTYPE html>
 <html lang="en">
 
 <head>
 
     <title> Stock Portfolio Suggestion Engine </title>
 
     <!-- Bootstrap core CSS -->
     <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  
     <script
      src="https://code.jquery.com/jquery-1.12.4.min.js"
      integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
      crossorigin="anonymous"> 
      </script>    
     <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
     <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

 
 </head>
 
 <body>
 
     <div class="container">
 
         <form class="form-signin" action="/calculate" method="post" role="form" id="search_box">

             <h2 align="center">Stock Portfolio Suggestion Engine </h2>

             <!--dropdown for strategy 1-->
             <!--dropdown for strategy 1-->
            <span> Select investment strategy 1 (Mandatory) : </span>
              <select name="strategy_1">
                <option> None </option>
                <option>Index</option>
                <option>Value</option>
                <option>Growth</option>
                <option>Ethical</option>
                <option>Quality</option>
              </select>
              <br><br>

            <!--dropdown for strategy 2-->
            <span> Select investment strategy 2 (Optionally)   : </span>
              <select name="strategy_2">
                <option> None </option>
                <option>Index</option>
                <option>Value</option>
                <option>Growth</option>
                <option>Ethical</option>
                <option>Quality</option>
              </select>
              <br><br>

             <input type="text" name="total_amount" id="symbol" class="form-control" placeholder="Enter Amount To Invest" required autofocus> 
             <br>
             <button class="btn btn-lg btn-primary btn-block" type="button" id="calc_button">Calculate </button>
         </form>


      
     </div>


    <h3 align='center' id='live_portfolio_announcement'> Live portfolio value: 
        <span id='live_portfolio_value'> </span> 
    </h3>

    <br><br> <h4 align='center' id ='portfolio_title'> Portfolio breakdown: </h3> <br>
    <div class='container'>
     <div class="row" id='main_container'>
           <div class = 'col-md-12' id='stock_container'> 
           <table id='stock_table' class="table table-striped">
           </table>         
           </div>           
     </div>
     </div>
    
    <br><br> <h4 align='center' id ='portfolio_title_history'> Portfolio 5-day history: </h3> <br>
    <div class="container" id='five_day_stocks' style='width: 900px; height: 500px;'></div>
    <div class="container" id='portfolio_stocks' style='width: 900px; height: 500px;'></div>
     
    <br><br> <h4 align='center' id ='portfolio_title_pies'> Portfolio breakdown charts: </h3> <br>
    <div class="container">
         <div class="row">
             <div class='col-md-6' id="stocks_piechart" style="width: 900px; height: 500px;"></div>
             <div class='col-md-6' id="counts_piechart" style="width: 900px; height: 500px;"></div>
         </div>
     </div>


     
   
     <script type="text/javascript">

        var g_portfolio;
         
        function drawStockChart(){

            var input = [];
            var rows = [];
            var heading = ['Date'];
            for (var stock in g_portfolio){
                heading.push(g_portfolio[stock].name);
            }
            rows.push(heading);

            for(var i = 0; i < 5; i++){
                var is_date_filled = false;
                for (var stock in g_portfolio){
                    //need to add date, and five days of closes
                    if(is_date_filled === false){
                        input.push(g_portfolio[stock].five_day_data[i]['Date']);
                        is_date_filled = true;
                    }
                    var stock_price = parseInt(g_portfolio[stock].five_day_data[i]['Close']);
                    input.push(stock_price);
                }
                rows.push(input);
                input = []
            }

            var data = new google.visualization.arrayToDataTable(rows);

            var options = {
                title: 'Five day history (individual stocks)',
                legend: { position: 'right' },
            };

            var chart = new google.visualization.LineChart(document.getElementById('five_day_stocks'));
            chart.draw(data, options);

        }

        function drawPortfolioChart(){

            var input = [];
            var rows = [];
            var heading = ['Date', 'Closing Portfolio Value'];
            rows.push(heading);
            for(var i = 0; i < 5; i++){
                var is_date_filled = false;
                var portfolio_price = 0;
                var portfolio_total = 0;

                for (var stock in g_portfolio){
                    //need to add date, and five days of closes
                    if(is_date_filled === false){
                        input.push(g_portfolio[stock].five_day_data[i]['Date']);
                        is_date_filled = true;
                    }
                    portfolio_price = parseInt(g_portfolio[stock].five_day_data[i]['Close']);
                    number_of_stocks = parseInt(g_portfolio[stock].count);
                    portfolio_total += (portfolio_price * number_of_stocks);
                }
                input.push(portfolio_total);
                rows.push(input);
                portfolio_total = 0;
                input = []
            }

            var data = new google.visualization.arrayToDataTable(rows);

            var options = {
                title: 'Five day history (portfolio)',
                legend: { position: 'bottom' },
            };

            var chart = new google.visualization.LineChart(document.getElementById('portfolio_stocks'));
            chart.draw(data, options);

        }


        function drawPieChart() {

            var rows = [];

            rows.push(['Stock', 'Amount spent']);

            for (var stock in g_portfolio){
                var input = [];
                input.push(g_portfolio[stock].name);
                input.push(g_portfolio[stock].amount);
                rows.push(input);
            }

            var data = google.visualization.arrayToDataTable(rows);

            var options = {
              title: 'Portfolio breakdown by stock',
            };

            var chart = new google.visualization.PieChart(document.getElementById('stocks_piechart'));
            chart.draw(data, options);
        }

        function drawPieChartByCount() {

            var rows = [];

            rows.push(['Stock', 'Stocks bought']);

            for (var stock in g_portfolio){
                var input = [];
                input.push(g_portfolio[stock].name);
                input.push(g_portfolio[stock].count);
                rows.push(input);
            }

            var data = google.visualization.arrayToDataTable(rows);

            var options = {
              title: 'Portfolio breakdown by stock'
            };

            var chart = new google.visualization.PieChart(document.getElementById('counts_piechart'));
            chart.draw(data, options);
        }


         $(function(){

            $("#stock_image").hide();
            $("#portfolio_image").hide();
            $('#portfolio_title').hide();
            $('#portfolio_title_history').hide();
            $('#portfolio_title_pies').hide();
            $('#live_portfolio_announcement').hide();

            $(window).keydown(function(event){
                if(event.keyCode == 13){
                    $("#calc_button").click();
                    event.preventDefault();
                    return false;
                }
            });

            function update_values() {
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
            $.getJSON($SCRIPT_ROOT+"/live_value",
                function(data) {
                    console.log(data);
                    if (data.live_value !== 0){
                    $('#live_portfolio_announcement').show();
                    $("#live_portfolio_value").show();
                    $("#live_portfolio_value").text(data.live_value);
                    }
                });
            }


            window.setInterval(function(){
              update_values();
            }, 5000);


            $('#calc_button').click(function(){
                var symbol = $('#symbol').val();
                $.ajax({
                    url: '/calculate',
                    data: $('form').serialize(),
                    type: 'POST',
                    success: function(response) {

                        //console.log(response)
                        //handle all errors here
                        if(response['code'] != 0){
                            alert(response['message'])
                            return;
                        }

                        //else, continue
                        $("#stock_image").show();
                        $("#portfolio_image").show();
                        
                        d = new Date();
                        //$("#stock_image").attr("src", "static/stocks.png?"+d.getTime());  
                        //$("#portfolio_image").attr("src", "static/portfolio.png?"+d.getTime());                        
                        var portfolio = response.portfolio;
                        portfolio = JSON.parse(portfolio);
                        g_portfolio = portfolio;
                        $('#portfolio_title').show();
                        $('#portfolio_title_history').show();
                        $('#portfolio_title_pies').show();

                        var heading = '<thead class="thead-inverse"> <tr>' + 
                                            '<th> Stock </th> <th> Name</th> <th>Strategy used</th>' +
                                            '<th> Stocks bought </th> <th> Price </th> <th> Amount spent </th>' +
                                            '</tr> </thead> <tbody> </tbody>';

                        $('#stock_table').append(heading);

                        for (var stock in portfolio){

                            var string_of_rows = '<tr>' + '<td>' + '<h5>' + stock + '</h5>' + '</td>' +
                            '<td>' + portfolio[stock].name + '</td>' +
                            '<td>' + portfolio[stock].strategy  + '</td>' +
                            '<td>' + portfolio[stock].count + '</td>' +
                            '<td>' + portfolio[stock].price + '</td>' +
                            '<td>' + portfolio[stock].amount + '</td>' + '</tr>';

                            $('#stock_table > tbody:last-child').append(string_of_rows);
                        }


                        google.charts.load("current", {packages:["corechart"]});
                        google.charts.setOnLoadCallback(drawStockChart);

                        google.charts.setOnLoadCallback(drawPortfolioChart);
                        google.charts.setOnLoadCallback(drawPieChart);
                        google.charts.setOnLoadCallback(drawPieChartByCount);
                        
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
                
            });

         });

     </script>

 </body>
 
 </html>